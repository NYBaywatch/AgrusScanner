---
phase: 02-core-scanning-engine
plan: 05
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - src/hooks/useScan.ts
  - src/components/ScanControls.tsx
  - src/components/ScanResults.tsx
  - src/components/ScanProgress.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can enter an IP range in CIDR or start-end format"
    - "User can select port scan preset (Simple, Full, AI Ports, Custom)"
    - "User can input custom port list when Custom preset selected"
    - "User can configure timeout and concurrency settings"
    - "User can start a ping sweep and see live hosts stream in"
    - "User can start a port scan and see open ports per host stream in"
    - "Scan progress shows percentage, host count, and elapsed time"
    - "User can cancel a running scan"
    - "Results show IP, hostname, open ports with service names"
  artifacts:
    - path: "src/hooks/useScan.ts"
      provides: "React hook wrapping Tauri scan commands with Channel handling"
      exports: ["useScan"]
    - path: "src/components/ScanControls.tsx"
      provides: "Scan configuration form (IP range, preset, ports, timeout, concurrency)"
      exports: ["default"]
    - path: "src/components/ScanResults.tsx"
      provides: "Results table showing discovered hosts and open ports"
      exports: ["default"]
    - path: "src/components/ScanProgress.tsx"
      provides: "Progress bar with percentage, host count, elapsed time"
      exports: ["default"]
    - path: "src/App.tsx"
      provides: "Updated root component composing scan UI"
  key_links:
    - from: "src/hooks/useScan.ts"
      to: "start_ping_sweep command"
      via: "invoke with Channel"
      pattern: "invoke.*start_ping_sweep"
    - from: "src/hooks/useScan.ts"
      to: "start_port_scan command"
      via: "invoke with Channel"
      pattern: "invoke.*start_port_scan"
    - from: "src/hooks/useScan.ts"
      to: "cancel_scan command"
      via: "invoke"
      pattern: "invoke.*cancel_scan"
    - from: "src/components/ScanControls.tsx"
      to: "src/hooks/useScan.ts"
      via: "hook consumption"
      pattern: "useScan"
    - from: "src/components/ScanResults.tsx"
      to: "src/hooks/useScan.ts"
      via: "results from hook state"
      pattern: "results|hosts"
    - from: "src/App.tsx"
      to: "src/components/ScanControls.tsx"
      via: "component composition"
      pattern: "ScanControls"
---

<objective>
Build the React frontend for scan control, real-time progress display, and results rendering. Wire to Tauri scan commands via Channel-based IPC.

Purpose: This is what the user sees and interacts with. It must feel responsive (streaming results), informative (progress + stats), and controllable (start/cancel with configuration).
Output: Complete scan UI with controls, progress bar, and results table -- the user can perform end-to-end network scans.
</objective>

<execution_context>
@C:\Users\jfago\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jfago\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-scanning-engine/02-RESEARCH.md
@.planning/phases/02-core-scanning-engine/02-04-SUMMARY.md
@src/App.tsx
@src/components/PlatformStatus.tsx
@src/hooks/usePlatformChecks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useScan hook with Channel integration</name>
  <files>
    src/hooks/useScan.ts
  </files>
  <action>
    Create src/hooks/useScan.ts:

    Define TypeScript types mirroring the Rust ScanProgress enum:

    interface PortResult { port: number; service: string; }
    interface HostResult { ip: string; hostname: string | null; open_ports: PortResult[]; is_alive: boolean; }

    type ScanProgress =
      | { type: "Started"; total_hosts: number }
      | { type: "HostDiscovered"; ip: string; hostname: string | null }
      | { type: "HostScanned"; ip: string; hostname: string | null; open_ports: PortResult[] }
      | { type: "Progress"; scanned: number; total: number; percent: number }
      | { type: "Completed"; total_hosts: number; hosts_alive: number; duration_ms: number }
      | { type: "Cancelled"; scanned: number; total: number }
      | { type: "Error"; message: string }

    interface ScanState {
      isScanning: boolean;
      progress: { scanned: number; total: number; percent: number } | null;
      hosts: HostResult[];
      error: string | null;
      duration: number | null;  // ms
      scanType: "ping" | "port" | null;
    }

    Export function useScan():
    Returns: { ...ScanState, startPingSweep, startPortScan, cancelScan }

    startPingSweep(config: { range: string; timeoutMs: number; concurrency: number }):
    1. Set isScanning = true, clear previous results, set scanType = "ping"
    2. Use Tauri Channel API to invoke "start_ping_sweep":
       - Import { Channel } from "@tauri-apps/api/core"
       - Create channel = new Channel<ScanProgress>()
       - Set channel.onmessage = handler function
       - invoke("start_ping_sweep", { range, timeoutMs, concurrency, onProgress: channel })
    3. Channel handler processes each ScanProgress:
       - Started: set total
       - HostDiscovered: append to hosts array (with is_alive=true, empty open_ports)
       - Progress: update progress state
       - Completed: set isScanning=false, set duration
       - Cancelled: set isScanning=false
       - Error: set error, set isScanning=false
    4. On invoke rejection (catch), set error and isScanning=false

    startPortScan(config: { range: string; portPreset: string; customPorts?: string; timeoutMs: number; concurrency: number }):
    1. Same pattern as ping sweep but invokes "start_port_scan"
    2. Set scanType = "port"
    3. Channel handler processes HostScanned (has open_ports) instead of HostDiscovered
    4. Upsert hosts: if host already in list (from prior ping sweep), update its open_ports. Otherwise add new entry.

    cancelScan():
    1. invoke("cancel_scan") -- fire and forget (catch errors silently)

    IMPORTANT:
    - Use React useState for all state. Do NOT use useReducer (keep it simple).
    - When processing HostDiscovered/HostScanned, use functional state update: setHosts(prev => [...prev, newHost]) to avoid stale closures.
    - The Channel callback runs outside React's render cycle, so functional updates are essential.
    - Export the PortResult and HostResult types for use in components.

    Check @tauri-apps/api/core Channel API -- if Channel constructor differs from the pattern above, adapt. The key is: create a channel, pass it as a parameter to invoke, receive messages on it. Tauri v2 Channel API: `const channel = new Channel<T>(); channel.onmessage = (msg) => { ... }; invoke("cmd", { onProgress: channel });`
  </action>
  <verify>
    Run `npm run build` (or the TypeScript compiler check). Types should compile. The hook should export useScan with correct return type. No TypeScript errors.
  </verify>
  <done>
    useScan hook manages scan state, invokes Tauri commands with Channel for progress streaming, handles all ScanProgress variants, supports ping sweep and port scan, cancel works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scan UI components</name>
  <files>
    src/components/ScanControls.tsx
    src/components/ScanProgress.tsx
    src/components/ScanResults.tsx
    src/App.tsx
  </files>
  <action>
    Follow the existing hacker aesthetic: dark backgrounds (#0a0a0a, #111), green accents (#00ff41), monospace fonts, inline styles. Match PlatformStatus.tsx patterns.

    1. Create src/components/ScanControls.tsx:

       Props: { onStartPingSweep, onStartPortScan, onCancel, isScanning, defaultSubnet }

       Layout:
       - IP Range input: text field, pre-filled with defaultSubnet from usePlatformChecks, placeholder "192.168.1.0/24 or 192.168.1.1-254"
       - Port Preset selector: 4 buttons/radio (Simple, Full, AI Ports, Custom), styled as pill buttons with green active state
       - Custom Ports input: text field, only visible when Custom preset selected, placeholder "80,443,8000-9000"
       - Settings row: Timeout input (number, default 500, label "Timeout (ms)"), Concurrency input (number, default 50, label "Threads")
       - Action buttons row:
         - "Ping Sweep" button: calls onStartPingSweep with current config, disabled when isScanning
         - "Port Scan" button: calls onStartPortScan with current config, disabled when isScanning
         - "Cancel" button: calls onCancel, only visible when isScanning, red color (#ff3333)

       Style: Dark card background (#111), border (#222), green focus rings on inputs, monospace font in inputs. Inputs should have dark backgrounds (#0d0d0d), light borders (#333), green text on focus.

    2. Create src/components/ScanProgress.tsx:

       Props: { progress, isScanning, duration, scanType }

       Layout (only visible when isScanning or progress exists):
       - Progress bar: full-width bar with green (#00ff41) fill, percentage as text overlay
       - Stats row: "Scanned: X/Y" | "Elapsed: Xs" | scan type label
       - Use CSS width percentage for the bar fill (inline style width: `${percent}%`)

       When scan completes, show final stats: "Scan complete: X hosts found in Y.Zs"

    3. Create src/components/ScanResults.tsx:

       Props: { hosts, scanType }

       Layout:
       - If no hosts: show "No results yet. Start a scan above." in dim text
       - Table with columns:
         - IP Address (monospace, green)
         - Hostname (or "-" if null)
         - Status (green dot for alive)
         - Open Ports (comma-separated "port/service" format, e.g., "22/SSH, 80/HTTP, 443/HTTPS")
       - Table header: uppercase, dim text (#888), border-bottom
       - Table rows: dark background alternating (#111, #0d0d0d), hover highlight
       - Summary footer: "X hosts found, Y with open ports"

       Style: Full-width table, monospace font for IPs and ports, scrollable if many results (max-height with overflow-y: auto).

    4. Update src/App.tsx:

       - Import useScan hook, ScanControls, ScanProgress, ScanResults, and existing PlatformStatus
       - Import usePlatformChecks for the subnet default
       - Layout:
         - Header: "Agrus Scanner" (existing)
         - PlatformStatus (existing, keep as-is but make it collapsible or smaller -- wrap in a details/summary or just keep it above)
         - ScanControls (pass useScan handlers and usePlatformChecks subnet)
         - ScanProgress (pass progress state)
         - ScanResults (pass hosts)
       - Use a simple vertical layout with spacing between sections

       Keep inline styles consistent with existing pattern. Do NOT add CSS files (deferred to Phase 4).
  </action>
  <verify>
    Run `npm run build` to verify TypeScript compilation. No type errors. Then run the dev server (`npm run tauri dev` or equivalent) and verify:
    - UI renders with scan controls, preset buttons, inputs
    - Typing in IP range field works
    - Preset buttons toggle correctly
    - Custom ports field shows/hides based on preset selection
    - If backend is available, a ping sweep or port scan can be initiated
  </verify>
  <done>
    Complete scan UI with: IP range input (pre-filled with detected subnet), port preset selector (4 options), custom ports input, timeout/concurrency settings, start/cancel buttons, progress bar with stats, results table with IP/hostname/ports/services. All styled in hacker aesthetic matching Phase 1.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 2 scan engine: Rust backend with ping sweep, port scanning, reverse DNS, cancellation, and progress streaming via Tauri Channels. React frontend with scan controls, real-time progress bar, and streaming results table.
  </what-built>
  <how-to-verify>
    1. Run `npm run tauri dev` (or the project's dev command) to launch the app
    2. Verify platform status cards still display correctly
    3. Verify IP range field is pre-filled with your detected subnet
    4. Click "Ping Sweep" -- hosts should stream in as they're discovered
    5. Verify progress bar shows percentage and host count
    6. Click "Cancel" during a scan -- verify it stops
    7. After ping sweep completes, verify hostnames appear for discovered hosts
    8. Select "Simple" preset, click "Port Scan" -- open ports should stream in per host
    9. Select "AI Ports" preset, run port scan -- verify AI-specific ports are checked
    10. Try "Custom" preset, enter "80,443,8080", run scan
    11. Change timeout to 1000ms and concurrency to 25, run scan -- verify it still works
    12. Verify results table shows IP, hostname, and open ports with service names
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles without errors (`npm run build`)
- Tauri dev build succeeds (`npm run tauri dev`)
- useScan hook correctly invokes all 3 Tauri commands
- Channel streaming delivers real-time updates to React state
- All 4 port presets selectable and pass correct values to backend
- Progress bar updates in real-time during scan
- Cancel button stops active scan
- Results table renders hosts with ports and service names
- UI matches hacker aesthetic (dark theme, green accents, monospace)
</verification>

<success_criteria>
- User can enter IP range (CIDR or start-end) and it's accepted
- User can select any port preset and see correct ports scanned
- User can input custom port list/ranges
- User can configure timeout and concurrency
- Ping sweep discovers hosts and streams results in real-time
- Port scan discovers open ports with service names
- Progress shows percentage, count, and elapsed time
- Cancel stops scans without crashes
- Results display in readable table format
- All hacker aesthetic styling consistent with Phase 1
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-scanning-engine/02-05-SUMMARY.md`
</output>
